<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CubeVerse</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5; }
        canvas { border: 1px solid black; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const player = { x: 100, y: 100, size: 30, color: 'green', health: 100 };
        const players = {}; // Other players
        const bullets = [];
        const speed = 6; // Increased speed
        let velocityX = 0, velocityY = 0;
        let slidingVelocityX = 0, slidingVelocityY = 0;
        const friction = 0.9; // Friction for sliding
        const keysPressed = { w: false, a: false, s: false, d: false };

        function updateVelocity() {
            let targetVelocityX = 0;
            let targetVelocityY = 0;
            if (keysPressed['w']) targetVelocityY -= speed;
            if (keysPressed['s']) targetVelocityY += speed;
            if (keysPressed['a']) targetVelocityX -= speed;
            if (keysPressed['d']) targetVelocityX += speed;

            velocityX = targetVelocityX;
            velocityY = targetVelocityY;
        }

        // Apply friction for sliding effect
        function applySliding() {
            slidingVelocityX += velocityX;
            slidingVelocityY += velocityY;
            slidingVelocityX *= friction;
            slidingVelocityY *= friction;
            player.x += slidingVelocityX;
            player.y += slidingVelocityY;
        }

        // Movement controls
        window.addEventListener('keydown', (e) => { if (e.key in keysPressed) { keysPressed[e.key] = true; updateVelocity(); } });
        window.addEventListener('keyup', (e) => { if (e.key in keysPressed) { keysPressed[e.key] = false; updateVelocity(); } });

        // Fire bullet
        window.addEventListener('click', () => {
            socket.emit('shootBullet', { x: player.x, y: player.y });
        });

        function randomSpawn() {
            player.x = Math.random() * (canvas.width - player.size);
            player.y = Math.random() * (canvas.height - player.size);
        }
        randomSpawn();

        // Send movement data to the server
        function movePlayer() {
            socket.emit('playerMovement', { x: player.x, y: player.y });
        }

        setInterval(movePlayer, 16);

        // Render game loop
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw player
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.size, player.size);

            // Draw health bar
            ctx.fillStyle = 'red';
            ctx.fillRect(player.x, player.y - 10, player.size, 5);
            ctx.fillStyle = 'green';
            ctx.fillRect(player.x, player.y - 10, player.size * (player.health / 100), 5);

            // Draw other players
            for (const id in players) {
                const p = players[id];
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);

                // Draw health bar
                ctx.fillStyle = 'red';
                ctx.fillRect(p.x, p.y - 10, p.size, 5);
                ctx.fillStyle = 'green';
                ctx.fillRect(p.x, p.y - 10, p.size * (p.health / 100), 5);
            }

            // Draw bullets
            bullets.forEach(bullet => {
                ctx.fillStyle = 'black';
                ctx.fillRect(bullet.x, bullet.y, bullet.size, bullet.size);
            });

            requestAnimationFrame(render);
        }

        // Update game state from the server
        socket.on('updateGameState', (data) => {
            Object.assign(players, data.players);
            player.health = data.player.health;
            bullets.length = 0;
            bullets.push(...data.bullets);
        });

        function gameLoop() {
            applySliding();
            render();
        }
        setInterval(gameLoop, 16);
    </script>
</body>
</html>
